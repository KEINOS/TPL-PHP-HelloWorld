language: php

env:
  global:
  - PHAN_DISABLE_XDEBUG_WARN=1
  - COMPOSER=composer.json

install: |
  php -i | grep php.ini | grep Configuration | grep Path | awk '{ print $6 }' && \
  echo $(php -r 'echo ini_get("extension_dir");') && \
  if php -r 'exit(version_compare(PHP_VERSION, "7.2.0", ">=") ? 0 : 1);'; then \
    echo '-- UPDATE xdebug.ini' \
    && ls -la /usr/local/etc/php/conf.d \
    && echo "zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)" > /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.mode=coverage" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.start_with_request=yes" >> /usr/local/etc/php/conf.d/xdebug.ini; \
  else \
    echo '-- DOWNGRADE Xdebug' \
    && yes | pecl install xdebug-2.9.8 \
    && echo "zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)" > /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_enable=on" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_autostart=on" >> /usr/local/etc/php/conf.d/xdebug.ini; \
  fi \
  && sudo snap install tree \
  && /bin/bash ./.devcontainer/setup_composer.sh --dev

matrix:
  include:
    # PHP 7.0-7.2support deprecated. Many test packages supports only >= 7.3.0
    #- php: 7.0
    #  dist: xenial
    #- php: 7.1
    #  dist: bionic
    #- php: 7.1.33
    #  dist: xenial
    #- php: 7.2
    #  dist: bionic
    # Default PHP version in macOS Catalina(10.15.7) and later
    - php: 7.3.11
      dist: bionic
    - php: 7.3
      dist: bionic
    - php: 7.4
      dist: bionic
    - php: 8.0.0
      dist: bionic
    - php: nightly
      dist: bionic
  allow_failures:
    - php: nightly

script:
  - /bin/bash ./tests/run-tests.sh --local --all --verbose
  - php ./.devcontainer/initialize_package.php MyVendorName
  - /bin/bash ./tests/run-tests.sh --local --all --verbose
